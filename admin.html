<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Earning App</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f7f6; margin: 0; }
        .navbar { background: linear-gradient(to right, #2c3e50, #4ca1af); color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container { max-width: 1000px; margin: 20px auto; padding: 15px; }
        .section { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 30px; }
        h2 { margin-top: 0; color: #333; border-bottom: 2px solid #f4f7f6; padding-bottom: 10px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #555; font-weight: 600; }
        
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; color: white; font-size: 12px; margin-right: 5px; }
        .btn-approve { background: #28a745; }
        .btn-reject { background: #dc3545; }
        .btn-delete { background: #dc3545; }
        
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; color: white; font-weight: bold; }
        .bg-pending { background: #ffc107; color: #333; }
        .bg-approved { background: #28a745; }
        .bg-rejected { background: #dc3545; }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: #fff; padding: 25px; border-radius: 10px; width: 90%; max-width: 400px; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #888; }
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 13px; color: #555; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .btn-edit { background: #17a2b8; }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>Admin Panel</h1>
        <a href="index.html" style="color:white; text-decoration:none; font-weight:bold;">Logout</a>
    </div>

    <div class="container">
        <!-- Withdrawals Section -->
        <div class="section">
            <h2>Withdrawal Requests</h2>
            <table>
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Amount</th>
                        <th>Method</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="withdrawalsTable">
                    <tr><td colspan="5">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Users Section -->
        <div class="section">
            <h2>User Management</h2>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Balance</th>
                        <th>Plan</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="usersTable">
                    <tr><td colspan="6">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeEditModal()">&times;</span>
            <h3 style="margin-top:0;">Edit User</h3>
            <input type="hidden" id="editUserId">
            
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="editName">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="editEmail">
            </div>
            <div class="form-group">
                <label>Phone</label>
                <input type="text" id="editPhone">
            </div>
            <div class="form-group">
                <label>Balance (Earning Points)</label>
                <input type="number" id="editBalance" step="0.01">
            </div>
            <div class="form-group">
                <label>Plan Status</label>
                <select id="editPlan">
                    <option value="0">Free Plan</option>
                    <option value="1">Premium Plan</option>
                </select>
            </div>
            <div class="form-group">
                <label>New Password (leave blank to keep current)</label>
                <input type="text" id="editPassword" placeholder="Enter new password">
            </div>
            
            <button class="btn btn-approve" onclick="saveUserChanges()" style="width:100%; padding:10px; font-size:14px;">Save Changes</button>
        </div>
    </div>

    <script>
        const API_URL = 'api.php';

        async function loadData() {
            // Load Users
            const resUsers = await fetch(`${API_URL}?action=admin_get_users`);
            const users = await resUsers.json();
            document.getElementById('usersTable').innerHTML = users.map(u => `
                <tr>
                    <td>${u.id}</td>
                    <td>${u.name}</td>
                    <td>${u.email}</td>
                    <td>${parseFloat(u.total_earnings).toFixed(2)}</td>
                    <td>${u.is_premium ? '<span class="badge bg-approved">Premium</span>' : 'Free'}</td>
                    <td>
                        <button class="btn btn-edit" onclick="openEditModal(${u.id})">Edit</button>
                        <button class="btn btn-delete" onclick="deleteUser(${u.id})">Delete</button>
                    </td>
                </tr>
            `).join('');

            // Load Withdrawals
            const resWith = await fetch(`${API_URL}?action=admin_get_withdrawals`);
            const withdrawals = await resWith.json();
            document.getElementById('withdrawalsTable').innerHTML = withdrawals.map(w => `
                <tr>
                    <td>${w.name}<br><small style="color:#888">${w.email}</small></td>
                    <td>${w.amount}</td>
                    <td>${w.method}</td>
                    <td><span class="badge bg-${w.status}">${w.status.toUpperCase()}</span></td>
                    <td>
                        ${w.status === 'pending' ? `
                        <button class="btn btn-approve" onclick="updateWithdrawal(${w.id}, 'approved')">Approve</button>
                        <button class="btn btn-reject" onclick="updateWithdrawal(${w.id}, 'rejected')">Reject</button>
                        ` : '-'}
                    </td>
                </tr>
            `).join('');
        }

        async function deleteUser(id) {
            if(!confirm('Are you sure you want to delete this user?')) return;
            await fetch(`${API_URL}?action=admin_delete_user`, { method: 'POST', body: JSON.stringify({id}) });
            loadData();
        }

        async function updateWithdrawal(id, status) {
            if(!confirm(`Mark this request as ${status}?`)) return;
            await fetch(`${API_URL}?action=admin_update_withdrawal`, { method: 'POST', body: JSON.stringify({id, status}) });
            loadData();
        }

        // Edit User Functions
        async function openEditModal(id) {
            const res = await fetch(`${API_URL}?action=admin_get_user&id=${id}`);
            const user = await res.json();
            
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editName').value = user.name;
            document.getElementById('editEmail').value = user.email;
            document.getElementById('editPhone').value = user.phone;
            document.getElementById('editBalance').value = user.total_earnings;
            document.getElementById('editPlan').value = user.is_premium;
            document.getElementById('editPassword').value = ''; // Clear password field
            
            document.getElementById('editUserModal').style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('editUserModal').style.display = 'none';
        }

        async function saveUserChanges() {
            const id = document.getElementById('editUserId').value;
            const data = {
                id: id,
                name: document.getElementById('editName').value,
                email: document.getElementById('editEmail').value,
                phone: document.getElementById('editPhone').value,
                total_earnings: document.getElementById('editBalance').value,
                is_premium: document.getElementById('editPlan').value,
                password: document.getElementById('editPassword').value
            };

            const res = await fetch(`${API_URL}?action=admin_update_user`, {
                method: 'POST',
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if(result.success) {
                alert('User updated successfully!');
                closeEditModal();
                loadData();
            } else {
                alert('Error updating user');
            }
        }

        loadData();
    </script>
</body>
</html>