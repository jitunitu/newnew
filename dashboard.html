<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí∞ Smart Earning App - Auto Currency</title>
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.0/css/line.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
        :root{--primary:#00C851;--dark:#1a1a1a;--card:#fff;--text:#333;--success:#00C851;--premium:#FF6B35;--gold:#FFD700;}
        body{background:linear-gradient(135deg,#1e3c72,#2a5298);min-height:100vh;padding:20px;}
        
        .container{max-width:1200px;margin:0 auto;}
        .header{padding:30px;background:var(--card);border-radius:25px;box-shadow:0 25px 50px rgba(0,0,0,0.15);margin-bottom:30px;text-align:center;position:relative;overflow:hidden;}
        .header::before{content:'';position:absolute;top:0;left:0;right:0;height:5px;background:linear-gradient(90deg,var(--gold),var(--premium));}
        .header h1{font-size:2.8em;color:var(--dark);margin-bottom:15px;text-shadow:2px 2px 4px rgba(0,0,0,0.1);}
        .country-info{position:absolute;top:25px;left:25px;padding:10px 20px;background:var(--primary);color:white;border-radius:30px;font-size:1em;font-weight:600;box-shadow:0 5px 15px rgba(0,200,81,0.4);}
        .country-info{position:absolute;top:25px;left:25px;padding:10px 20px;background:var(--primary);color:white;border-radius:30px;font-size:1em;font-weight:600;box-shadow:0 5px 15px rgba(0,200,81,0.4); border:none; outline:none; cursor:pointer; appearance:none; -webkit-appearance:none; text-align: center;}
        .country-info option { color: #333; background: white; }
        .plan-status{position:absolute;top:25px;right:25px;padding:10px 20px;background:var(--premium);color:white;border-radius:30px;font-size:1em;font-weight:600;box-shadow:0 5px 15px rgba(255,107,53,0.4);}
        .plan-status.free{background:#28a745 !important;box-shadow:0 5px 15px rgba(40,167,69,0.4);}
        .balance{display:inline-flex;align-items:center;background:linear-gradient(135deg,var(--primary),#00a85a);color:white;padding:20px 40px;border-radius:50px;font-size:2em;font-weight:700;box-shadow:0 15px 40px rgba(0,200,81,0.4);position:relative;overflow:hidden;}
        .balance::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle,rgba(255,255,255,0.2) 0%,transparent 70%);animation:shine 3s infinite;}
        .balance i{font-size:2.8em;margin-right:20px;}
        @keyframes shine{0%{transform:translateX(-100%) translateY(-100%) rotate(45deg);}100%{transform:translateX(100%) translateY(100%) rotate(45deg);}}
        
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:25px;margin-bottom:30px;}
        .stat-card{background:var(--card);padding:30px;border-radius:25px;box-shadow:0 20px 40px rgba(0,0,0,0.1);text-align:center;transition:all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);}
        .stat-card:hover{transform:translateY(-15px) scale(1.02);box-shadow:0 30px 60px rgba(0,0,0,0.2);}
        .stat-icon{font-size:3.5em;background:linear-gradient(135deg,var(--primary),#00a85a);color:white;width:90px;height:90px;border-radius:50%;margin:0 auto 20px;display:flex;align-items:center;justify-content:center;box-shadow:0 10px 30px rgba(0,200,81,0.4);}
        .stat-number{font-size:2.8em;font-weight:800;color:var(--primary);margin-bottom:10px;text-shadow:1px 1px 2px rgba(0,0,0,0.1);}
        .stat-label{font-size:1.2em;color:var(--text);font-weight:600;letter-spacing:1px;}
        
        .joining-section{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:25px;margin-bottom:40px;}
        .joining-card{padding:40px;border-radius:25px;box-shadow:0 25px 50px rgba(0,0,0,0.15);text-align:center;position:relative;overflow:hidden;}
        .joining-card::before{content:'';position:absolute;top:0;left:0;right:0;height:5px;background:var(--gold);}
        .joining-card.free{background:linear-gradient(135deg,#28a745,#20c997);}
        .joining-card.premium{background:linear-gradient(135deg,var(--premium),#ff8e53);}
        .joining-card h3{font-size:1.8em;color:white;margin-bottom:20px;font-weight:700;text-shadow:2px 2px 4px rgba(0,0,0,0.3);}
        .joining-price{font-size:3.5em;font-weight:900;color:var(--gold);margin-bottom:25px;text-shadow:3px 3px 6px rgba(0,0,0,0.4);}
        .joining-btn{background:white;color:#333;border:none;padding:20px 40px;border-radius:50px;font-weight:700;font-size:1.2em;cursor:pointer;transition:all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);width:100%;box-shadow:0 10px 30px rgba(0,0,0,0.2);}
        .joining-btn:hover{transform:translateY(-8px) scale(1.05);box-shadow:0 20px 50px rgba(0,0,0,0.3);}
        .joining-btn.active,.joining-btn:disabled{background:var(--gold);color:#1a1a1a;font-weight:800;transform:none;box-shadow:0 10px 30px rgba(255,215,0,0.4);cursor:not-allowed;}
        
        .task-section{background:var(--card);border-radius:25px;padding:40px;box-shadow:0 25px 50px rgba(0,0,0,0.15);margin-bottom:30px;}
        .section-title{display:flex;align-items:center;font-size:2em;font-weight:700;color:var(--dark);margin-bottom:30px;}
        .section-title i{margin-right:20px;color:var(--primary);font-size:2.2em;}
        .tasks-list{display:flex;flex-direction:column;gap:20px;}
        .task-item{display:flex;align-items:center;padding:25px;background:#f8f9fa;border-radius:20px;transition:all 0.3s;cursor:pointer;border:2px solid transparent;}
        .task-item:hover{background:#e9ecef;border-color:var(--primary);}
        .task-item.completed{background:linear-gradient(135deg,var(--success),#00a85a);color:white;border-color:var(--success);}
        .task-checkbox{width:35px;height:35px;border:4px solid #ddd;border-radius:50%;margin-right:25px;display:flex;align-items:center;justify-content:center;font-size:1.5em;font-weight:700;transition:all 0.3s;background:transparent;}
        .task-item.completed .task-checkbox{background:white;color:var(--success);border-color:white;box-shadow:0 0 20px rgba(0,200,81,0.5);}
        .task-text{font-weight:600;font-size:1.1em;}
        .task-earning{font-weight:800;color:var(--primary);margin-left:auto;font-size:1.2em;}
        .task-item.completed .task-earning{color:white;}
        
        @media(max-width:768px){
            .joining-section{grid-template-columns:1fr;}
            .stats-grid{grid-template-columns:repeat(2,1fr);gap:15px;}
            .header h1{font-size:2.2em;}
            .country-info,.plan-status{top:15px;font-size:0.9em;padding:8px 15px;left:15px;right:15px;}
            .balance{font-size:1.6em;padding:15px 25px;}
        }
        
        .logout-btn { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px; color: white; cursor: pointer; border: 1px solid rgba(255,255,255,0.3); z-index: 100; font-weight: bold; }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: #fff; padding: 25px; border-radius: 15px; text-align: center; width: 90%; max-width: 350px; position: relative; box-shadow: 0 5px 20px rgba(0,0,0,0.2); animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #888; }
        .qr-img { width: 200px; height: 200px; margin: 15px 0; border: 1px solid #eee; padding: 5px; border-radius: 10px; }
        .btn-confirm-pay { width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 25px; font-size: 16px; cursor: pointer; margin-top: 10px; }

        /* Bottom Nav & Tabs */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 15px 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); z-index: 1000; border-top-left-radius: 20px; border-top-right-radius: 20px; }
        .nav-item { text-align: center; color: #888; cursor: pointer; font-size: 0.8rem; transition: 0.3s; }
        .nav-item.active { color: var(--primary); font-weight: bold; transform: translateY(-5px); }
        .nav-item i { font-size: 1.5rem; display: block; margin-bottom: 5px; }
        .tab-content { display: none; padding-bottom: 100px; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        
        /* Form Styles */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        .form-group input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; outline: none; }
        .btn-submit { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 25px; font-weight: bold; cursor: pointer; font-size: 16px; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #555; }
    </style>
</head>
<body>

    <div class="container">
        <!-- HOME TAB -->
        <div id="home-tab" class="tab-content active">
            <div class="header">
                <button class="logout-btn" onclick="logout()">Logout</button>
                <h1>üí∞ Smart Earning Dashboard</h1>
                <h2 id="userGreeting" style="color: #333; font-size: 1.2rem; margin-bottom: 10px;">Welcome</h2>
                <div class="country-info" id="countryInfo">Detecting...</div>
                <select class="country-info" id="currencySelector" onchange="changeCurrency()">
                    <option value="IN-INR">üáÆüá≥ INR (‚Çπ)</option>
                    <option value="US-USD">üá∫üá∏ USD ($)</option>
                    <option value="GB-GBP">üá¨üáß GBP (¬£)</option>
                    <option value="AE-AED">üá¶üá™ AED (ÿØ.ÿ•)</option>
                </select>
                <div class="plan-status free" id="planStatus">FREE Plan Active</div>
                <div class="balance">
                    <i class="uil uil-chart-line"></i>
                    <span id="totalBalance">0</span>
                </div>
            </div>
            
            <div class="joining-section">
                <div class="joining-card free">
                    <h3>üéâ Free Joining</h3>
                    <div class="joining-price" id="freePrice">$0</div>
                    <p style="color:white;margin-bottom:25px;font-size:1.1em;" id="freeBonusText">Join ‡§ï‡§∞‡§ï‡•á ‡§§‡•Å‡§∞‡§Ç‡§§ $50 ‡§¨‡•ã‡§®‡§∏ ‡§™‡§æ‡§è‡§Ç</p>
                    <button class="joining-btn active" disabled>Joined ‚úÖ</button>
                </div>
                <div class="joining-card premium">
                    <h3>‚≠ê Premium Plan</h3>
                    <div class="joining-price" id="premiumPrice">$1,000</div>
                    <p style="color:white;margin-bottom:25px;font-size:1.1em;" id="premiumText">Double Earnings + VIP Benefits</p>
                    <button class="joining-btn" onclick="buyPremium()" id="premiumBtn">Buy Premium</button>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon"><i class="uil uil-chart-line"></i></div>
                    <div class="stat-number" id="todayEarning">0</div>
                    <div class="stat-label">Today Earnings</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="uil uil-calendar-alt"></i></div>
                    <div class="stat-number" id="weekEarning">0</div>
                    <div class="stat-label">This Week</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="uil uil-wallet"></i></div>
                    <div class="stat-number" id="monthEarning">0</div>
                    <div class="stat-label">This Month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="uil uil-users-alt"></i></div>
                    <div class="stat-number" id="referrals">0</div>
                    <div class="stat-label">Referrals</div>
                </div>
            </div>
        </div>

        <!-- TASKS TAB -->
        <div id="tasks-tab" class="tab-content">
            <div class="task-section">
                <div class="section-title">
                    <i class="uil uil-task"></i>
                    <span id="taskTitle">Complete Daily Tasks (Premium: 2x Earnings)</span>
                </div>
                <div class="tasks-list">
                    <!-- Existing Tasks -->
                    <div class="task-item" onclick="completeTask(this, 'Daily Check-in')" data-amount="10">
                        <div class="task-checkbox">‚≠ï</div>
                        <span class="task-text">Daily Check-in</span>
                        <span class="task-earning">$10</span>
                    </div>
                    <div class="task-item" onclick="completeTask(this, 'Watch 2 Ads')" data-amount="25">
                        <div class="task-checkbox">‚≠ï</div>
                        <span class="task-text">Watch 2 Ads</span>
                        <span class="task-earning">$25</span>
                    </div>
                    <div class="task-item" onclick="completeTask(this, 'Share App')" data-amount="50">
                        <div class="task-checkbox">‚≠ï</div>
                        <span class="task-text">Share App</span>
                        <span class="task-earning">$50</span>
                    </div>
                    <div class="task-item" onclick="completeTask(this, 'Invite Friend')" data-amount="100">
                        <div class="task-checkbox">‚≠ï</div>
                        <span class="task-text">Invite Friend</span>
                        <span class="task-earning">$100</span>
                    </div>
                    
                    <!-- 5 NEW TASKS -->
                    <div class="task-item" onclick="completeTask(this, 'Watch Video')" data-amount="20">
                        <div class="task-checkbox">‚≠ï</div>
                        <span class="task-text">üì∫ Watch Video</span>
                        <span class="task-earning">$20</span>
                    </div>
                    <div class="task-item" onclick="completeTask(this, 'Play Quiz')" data-amount="30">
                        <div class="task-checkbox">‚≠ï</div>
                        <span class="task-text">‚ùì Play Quiz</span>
                        <span class="task-earning">$30</span>
                    </div>
                    <div class="task-item" onclick="completeTask(this, 'Spin Wheel')" data-amount="15">
                        <div class="task-checkbox">‚≠ï</div>
                        <span class="task-text">üé° Spin Wheel</span>
                        <span class="task-earning">$15</span>
                    </div>
                    <div class="task-item" onclick="completeTask(this, 'Scratch Card')" data-amount="25">
                        <div class="task-checkbox">‚≠ï</div>
                        <span class="task-text">üé´ Scratch Card</span>
                        <span class="task-earning">$25</span>
                    </div>
                    <div class="task-item" onclick="completeTask(this, 'Join Telegram')" data-amount="40">
                        <div class="task-checkbox">‚≠ï</div>
                        <span class="task-text">üì¢ Join Telegram</span>
                        <span class="task-earning">$40</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- WITHDRAW TAB -->
        <div id="withdraw-tab" class="tab-content">
            <div class="task-section">
                <div class="section-title">
                    <i class="uil uil-money-withdraw"></i>
                    <span>Withdraw Money</span>
                </div>
                <div style="background:#f8f9fa; padding:20px; border-radius:15px;">
                    <div class="form-group">
                        <label>Enter Amount</label>
                        <input type="number" id="withdrawAmount" placeholder="Min: 500">
                    </div>
                    <div class="form-group">
                        <label>Enter UPI ID</label>
                        <input type="text" id="withdrawUpi" placeholder="e.g. user@upi">
                    </div>
                    <button class="btn-submit" onclick="requestWithdrawal()">Request Withdrawal</button>
                </div>
            </div>
        </div>

        <!-- HISTORY TAB -->
        <div id="history-tab" class="tab-content">
            <div class="task-section">
                <div class="section-title">
                    <i class="uil uil-history"></i>
                    <span>Transaction History</span>
                </div>
                <div style="display:flex; justify-content:center; gap:10px; margin-bottom:15px;">
                    <button id="btnWithdrawals" onclick="switchHistory('withdrawals')" style="padding:8px 15px; border-radius:20px; border:none; background:var(--primary); color:white; cursor:pointer; font-weight:bold;">Withdrawals</button>
                    <button id="btnEarnings" onclick="switchHistory('earnings')" style="padding:8px 15px; border-radius:20px; border:1px solid #ddd; background:white; color:#555; cursor:pointer; font-weight:bold;">Task Earnings</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Method</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="transactionTable">
                        <tr><td colspan="4" style="text-align:center">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- PROFILE TAB -->
        <div id="profile-tab" class="tab-content">
            <div class="task-section">
                <div class="section-title">
                    <i class="uil uil-user-circle"></i>
                    <span>My Profile</span>
                </div>
                <div style="background:#f8f9fa; padding:20px; border-radius:15px;">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="profileName" placeholder="Enter full name">
                    </div>
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="profileEmail" placeholder="Enter new email">
                    </div>
                    <div class="form-group">
                        <label>New Password</label>
                        <input type="password" id="profilePassword" placeholder="Leave blank to keep current">
                    </div>
                    <button class="btn-submit" onclick="updateProfile()">Update Profile</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('home', this)">
            <i class="uil uil-home"></i> Home
        </div>
        <div class="nav-item" onclick="switchTab('tasks', this)">
            <i class="uil uil-check-square"></i> Tasks
        </div>
        <div class="nav-item" onclick="switchTab('withdraw', this)">
            <i class="uil uil-money-withdraw"></i> Withdraw
        </div>
        <div class="nav-item" onclick="switchTab('history', this)">
            <i class="uil uil-history"></i> History
        </div>
        <div class="nav-item" onclick="switchTab('profile', this)">
            <i class="uil uil-user"></i> Profile
        </div>
    </div>

<!-- Payment Modal -->
<div id="paymentModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h2 style="margin-top:0; color:#333;">Scan to Pay</h2>
        <p>Pay <strong>‚Çπ1000</strong> via UPI to upgrade.</p>
        <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=upi%3A%2F%2Fpay%3Fpa%3Dadmin%40upi%26pn%3DEarningApp%26am%3D1000%26tn%3DPremium" alt="UPI QR Code" class="qr-img">
        <p style="font-size: 13px; color: #666; margin-bottom: 15px;">UPI ID: <strong>admin@upi</strong></p>
        <button class="btn-confirm-pay" onclick="processPremiumPurchase()">I have Paid</button>
    </div>
</div>

<script>
    const API_URL = 'api.php';
    const userId = localStorage.getItem('user_id');
    let isPremiumUser = false;
    let currencyFormatter;
    let userData = null; // Store user data globally for re-rendering
    let transactionData = []; // Store transactions globally
    let currentMultiplier = 1;

    if (!userId) {
        window.location.href = 'index.html';
    }

    // ================= AUTO CURRENCY DETECTION =================
    const countryToCurrency = {
        "IN": "INR", "PK": "PKR", "AE": "AED", "US": "USD", 
        "GB": "GBP", "SA": "SAR", "BD": "BDT", "NP": "NPR",
        "AU": "AUD", "CA": "CAD", "DE": "EUR", "FR": "EUR"
    };
    function initCurrency() {
        const selector = document.getElementById('currencySelector');
        // Default to INR if not set, or try to detect
        // For now, we let the select box default (INR)
        updateCurrencyFormatter();
    }

    const userLocale = navigator.language || navigator.userLanguage || "en-IN";
    const localeParts = userLocale.split("-");
    const countryCode = localeParts[1] || "IN";
    const currencyCode = countryToCurrency[countryCode] || "INR";
    
    currencyFormatter = new Intl.NumberFormat(userLocale, {
        style: 'currency',
        currency: currencyCode,
        minimumFractionDigits: 0
    });

    // Hindi text mapping
    const hindiTexts = {
        "IN": {free: "Join ‡§ï‡§∞‡§ï‡•á ‡§§‡•Å‡§∞‡§Ç‡§§", premium: "Double Earnings + VIP Benefits"},
        "PK": {free: "Join ⁄©ÿ±⁄©€í ŸÅŸàÿ±€å", premium: "Double ÿ¢ŸÖÿØŸÜ€å + VIP ŸÅŸàÿßÿ¶ÿØ"},
        "AE": {free: "ÿßŸÜÿ∂ŸÖ Ÿàÿßÿ∑ŸÑÿ® ŸÖŸÉÿßŸÅÿ£ÿ©", premium: "ÿ£ÿ±ÿ®ÿßÿ≠ ŸÖÿ≤ÿØŸàÿ¨ÿ© + ŸÖÿ≤ÿßŸäÿß VIP"},
        "default": {free: "Join to get instant", premium: "Double Earnings + VIP Benefits"}
    };
    const textConfig = hindiTexts[countryCode] || hindiTexts["default"];
    
    function updateCurrencyFormatter() {
        const selector = document.getElementById('currencySelector');
        const [country, currency] = selector.value.split('-');
        
        currencyFormatter = new Intl.NumberFormat('en-' + country, {
            style: 'currency',
            currency: currency,
            minimumFractionDigits: 0
        });
        
        renderPageData();
    }

    function renderPageData() {
        // Update Static Text based on currency/country
        const selector = document.getElementById('currencySelector');
        const countryCode = selector.value.split('-')[0];
        const textConfig = hindiTexts[countryCode] || hindiTexts["default"];

        document.getElementById('freePrice').textContent = currencyFormatter.format(0);
        document.getElementById('premiumPrice').textContent = currencyFormatter.format(1000);
        document.getElementById('freeBonusText').textContent = `Join ‡§ï‡§∞‡§ï‡•á ‡§§‡•Å‡§∞‡§Ç‡§§ ${currencyFormatter.format(50)} ‡§¨‡•ã‡§®‡§∏ ‡§™‡§æ‡§è‡§Ç`;
        document.getElementById('premiumText').textContent = textConfig.premium;
        
        // Update Task Amounts
        document.querySelectorAll('.task-item').forEach(item => {
            const amount = item.dataset.amount;
            item.querySelector('.task-earning').textContent = currencyFormatter.format(amount);
        });

        // Update User Data if available
        if (userData) {
            document.getElementById('userGreeting').innerText = `Welcome, ${userData.name}`;
            document.getElementById('totalBalance').innerText = currencyFormatter.format(userData.total_earnings);
            document.getElementById('todayEarning').innerText = currencyFormatter.format(userData.total_earnings);
            document.getElementById('weekEarning').innerText = currencyFormatter.format(userData.total_earnings);
            document.getElementById('monthEarning').innerText = currencyFormatter.format(userData.total_earnings);
            
            if(document.getElementById('profileEmail')) {
                document.getElementById('profileEmail').value = userData.email || '';
                document.getElementById('profileName').value = userData.name || '';
            }
        }

        // Update Transactions Table
        renderTransactions();
    }

    // Load Data on Start
    window.onload = function() {
        initCurrency();
        loadUserData();
        loadTransactions();
    };

    function switchHistory(type) {
        if (type === 'withdrawals') {
            loadTransactions();
        } else {
            loadEarnings();
        }
    }

    function switchTab(tabName, element) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.getElementById(tabName + '-tab').classList.add('active');
        
        if(element) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            element.classList.add('active');
        }
    }

    async function loadUserData() {
        document.getElementById('countryInfo').textContent = `${countryCode} (${currencyCode})`;

        try {
            const res = await fetch(`${API_URL}?action=get_user&user_id=${userId}`);
            const text = await res.text();

            if (text.trim().startsWith('<?php') || text.includes('<!DOCTYPE')) {
                alert("Error: PHP is not running. Please use XAMPP.");
                return;
            }
            
            let data;
            try {
                data = JSON.parse(text);
            } catch (e) {
                console.error("Invalid JSON:", text);
                return;
            }

            if (data.error) {
                alert('Session expired');
                logout();
                return;
            }

            userData = data;
            
            // Set user's country if available
            if (userData.country) {
                document.getElementById('currencySelector').value = userData.country;
                updateCurrencyFormatter(); // This updates formatter and calls renderPageData
            } else {
                renderPageData();
            }

            document.getElementById('referrals').innerText = "0"; // Placeholder

            // Update Plan Status
            isPremiumUser = data.is_premium;
            currentMultiplier = data.multiplier || 1;
            
            if(data.is_premium) {
                document.getElementById('planStatus').textContent = 'PREMIUM Active';
                document.getElementById('planStatus').className = 'plan-status';
                document.getElementById('premiumBtn').textContent = 'Premium Active ‚úÖ';
                document.getElementById('premiumBtn').classList.add('active');
                document.getElementById('premiumBtn').disabled = true;
                document.getElementById('taskTitle').textContent = `Complete Daily Tasks (Premium: 2x Earnings Active)`;
            }

        } catch (err) {
            console.error(err);
        }
    }

    async function loadTransactions() {
        // Update Buttons
        document.getElementById('btnWithdrawals').style.background = 'var(--primary)';
        document.getElementById('btnWithdrawals').style.color = 'white';
        document.getElementById('btnWithdrawals').style.border = 'none';
        document.getElementById('btnEarnings').style.background = 'white';
        document.getElementById('btnEarnings').style.color = '#555';
        document.getElementById('btnEarnings').style.border = '1px solid #ddd';

        const res = await fetch(`${API_URL}?action=get_transactions&user_id=${userId}`);
        const data = await res.json();
        
        const thead = document.querySelector('#history-tab thead tr');
        thead.innerHTML = '<th>Date</th><th>Amount</th><th>Method</th><th>Status</th>';

        if (data.success) {
            transactionData = data.data;
            renderTransactions();
        }
    }

    function renderTransactions() {
        const tbody = document.getElementById('transactionTable');
        if (transactionData.length > 0) {
            tbody.innerHTML = transactionData.map(t => `
                <tr>
                    <td>${new Date(t.created_at).toLocaleDateString()}</td>
                    <td style="color:red; font-weight:bold;">-${currencyFormatter.format(t.amount)}</td>
                    <td>${t.method}</td>
                    <td><span style="padding:3px 8px; border-radius:10px; font-size:12px; background:${t.status=='approved'?'#d4edda':'#fff3cd'}; color:${t.status=='approved'?'#155724':'#856404'}">${t.status.toUpperCase()}</span></td>
                </tr>
            `).join('');
        } else {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">No transactions found</td></tr>';
        }
    }

    async function loadEarnings() {
        // Update Buttons
        document.getElementById('btnEarnings').style.background = 'var(--primary)';
        document.getElementById('btnEarnings').style.color = 'white';
        document.getElementById('btnEarnings').style.border = 'none';
        document.getElementById('btnWithdrawals').style.background = 'white';
        document.getElementById('btnWithdrawals').style.color = '#555';
        document.getElementById('btnWithdrawals').style.border = '1px solid #ddd';

        const res = await fetch(`${API_URL}?action=get_earnings&user_id=${userId}`);
        const data = await res.json();

        const thead = document.querySelector('#history-tab thead tr');
        thead.innerHTML = '<th>Date</th><th>Amount</th><th>Task Name</th>';

        const tbody = document.getElementById('transactionTable');
        
        if (data.success && data.data.length > 0) {
            tbody.innerHTML = data.data.map(t => `
                <tr>
                    <td>${new Date(t.completed_at).toLocaleDateString()}</td>
                    <td style="color:green; font-weight:bold;">+${currencyFormatter ? currencyFormatter.format(t.earning_amount) : t.earning_amount}</td>
                    <td>${t.task_name}</td>
                </tr>
            `).join('');
        } else {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;">No earnings yet</td></tr>';
        }
    }

    async function completeTask(element, taskName) {
        const checkbox = element.querySelector('.task-checkbox');
        if (checkbox.textContent !== '‚≠ï') return; // Already done

        const amount = element.dataset.amount;

        const res = await fetch(`${API_URL}?action=complete_task`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                user_id: userId,
                task_name: taskName,
                amount: amount
            })
        });
        const data = await res.json();
        if (data.success) {
            checkbox.textContent = '‚úÖ';
            element.classList.add('completed');
            alert(`Task Completed! Earned: ${currencyFormatter.format(data.earnings)}`);
            loadUserData();
        } else {
            alert(data.message);
        }
    }

    function buyPremium() {
        if (isPremiumUser) {
            alert("Aap pahle se hi Premium User ho! (You are already a Premium User)");
            return;
        }
        document.getElementById('paymentModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('paymentModal').style.display = 'none';
    }

    async function processPremiumPurchase() {
        closeModal();
        const res = await fetch(`${API_URL}?action=buy_premium`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId })
        });
        const data = await res.json();
        alert(data.message);
        if (data.success) loadUserData();
    }

    async function updateProfile() {
        const name = document.getElementById('profileName').value;
        const email = document.getElementById('profileEmail').value;
        const password = document.getElementById('profilePassword').value;

        if (!email) { alert("Email is required"); return; }
        if (!email || !name) { alert("Name and Email are required"); return; }

        const res = await fetch(`${API_URL}?action=update_profile`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId, name: name, email: email, password: password })
        });
        const data = await res.json();
        alert(data.message);
        if (data.success) {
            document.getElementById('profilePassword').value = ''; // Clear password field
            loadUserData();
        }
    }

    async function requestWithdrawal() {
        const amount = document.getElementById('withdrawAmount').value;
        const upi = document.getElementById('withdrawUpi').value;

        if (!amount || !upi) { alert("Please fill all fields"); return; }

        const res = await fetch(`${API_URL}?action=request_withdrawal`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId, amount: amount, upi_id: upi })
        });
        const data = await res.json();
        alert(data.message);
        if (data.success) { loadUserData(); loadTransactions(); }
    }

    function logout() {
        localStorage.removeItem('user_id');
        window.location.href = 'index.html';
    }
</script>
</body>
</html>